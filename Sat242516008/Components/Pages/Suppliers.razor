@page "/suppliers"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]

@using Sat242516008.Models
@using MyDbModels
@using Providers
@using Loggers
@inject IMyDbModel_Provider Provider
@inject DbLogger DbLogger
@inject IJSRuntime JS
@rendermode InteractiveServer
@attribute [Authorize]

<div class="container-fluid">
    <h3 class="mt-3">Tedarikçi Yönetimi</h3>
    <hr />

    <div class="row mb-3">
        <div class="col-md-5">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Firma Adı Ara..." @bind="searchTerm" @bind:event="oninput" @onkeypress="HandleEnterKey" />
                <button class="btn btn-primary" @onclick="SearchData">Ara</button>
            </div>
        </div>
        <div class="col-md-7 text-end">
            <button class="btn btn-success" @onclick="OpenCreateModal">+ Yeni Tedarikçi</button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="cursor:pointer" @onclick='() => SortData("CompanyName")'>Firma Adı ⇅</th>
                        <th>Yetkili</th>
                        <th>Telefon</th>
                        <th>Durum</th>
                        <th style="width: 180px;">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (model.Items != null && model.Items.Any())
                    {
                        @foreach (var item in model.Items)
                        {
                            <tr>
                                <td>@item.CompanyName</td>
                                <td>@item.ContactName</td>
                                <td>@item.Phone</td>
                                <td>@(item.IsActive ? "Aktif" : "Pasif")</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-1" @onclick="() => OpenEditModal(item)">Düzenle</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item)">Sil</button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="5" class="text-center py-3">Kayıt bulunamadı.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @if (model.Parameters.TotalPageCount > 1)
    {
        <div class="d-flex justify-content-center mt-3">
            <nav>
                <ul class="pagination">
                    <li class="page-item @(model.Parameters.PageNumber <= 1 ? "disabled" : "")"><button class="page-link" @onclick="PrevPage">Önceki</button></li>
                    <li class="page-item disabled"><span class="page-link">Sayfa @model.Parameters.PageNumber / @model.Parameters.TotalPageCount</span></li>
                    <li class="page-item @(model.Parameters.PageNumber >= model.Parameters.TotalPageCount ? "disabled" : "")"><button class="page-link" @onclick="NextPage">Sonraki</button></li>
                </ul>
            </nav>
        </div>
    }

    @if (isModalVisible)
    {
        <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">@(activeItem.SupplierID > 0 ? "Tedarikçi Güncelle" : "Yeni Tedarikçi")</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3"><label>Firma Adı</label><input class="form-control" @bind="activeItem.CompanyName" /></div>
                        <div class="mb-3"><label>Yetkili Adı</label><input class="form-control" @bind="activeItem.ContactName" /></div>
                        <div class="mb-3"><label>Telefon</label><input class="form-control" @bind="activeItem.Phone" /></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" @bind="activeItem.IsActive" id="chkStat"><label class="form-check-label" for="chkStat">Aktif</label></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseModal">İptal</button>
                        <button class="btn btn-primary" @onclick="SaveData">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private MyDbModel<Supplier> model = new MyDbModel<Supplier>();
    private Supplier activeItem = new Supplier();
    private string searchTerm = "";
    private bool isModalVisible = false;

    protected override async Task OnInitializedAsync() { model.Parameters.OrderBy = "SupplierID DESC"; await LoadData(); }

    private async Task LoadData()
    {
        model.Parameters.Where.Clear();
        if (!string.IsNullOrEmpty(searchTerm)) model.Parameters.Where.Add("Search", searchTerm);
        model = (MyDbModel<Supplier>)await Provider.Execute<Supplier>(model, "sp_Suppliers_List", isPagination: true);
    }

    private async Task SearchData() { model.Parameters.PageNumber = 1; await LoadData(); }
    private async Task HandleEnterKey(KeyboardEventArgs e) { if (e.Key == "Enter") await SearchData(); }
    private async Task SortData(string col) { model.Parameters.OrderBy = col; await LoadData(); }
    private async Task NextPage() { if (model.Parameters.PageNumber < model.Parameters.TotalPageCount) { model.Parameters.PageNumber++; await LoadData(); } }
    private async Task PrevPage() { if (model.Parameters.PageNumber > 1) { model.Parameters.PageNumber--; await LoadData(); } }
    private void OpenCreateModal() { activeItem = new Supplier { IsActive = true }; isModalVisible = true; }
    private void OpenEditModal(Supplier item) { activeItem = new Supplier { SupplierID = item.SupplierID, CompanyName = item.CompanyName, ContactName = item.ContactName, Phone = item.Phone, IsActive = item.IsActive }; isModalVisible = true; }
    private void CloseModal() => isModalVisible = false;

    private async Task SaveData()
    {
        if (activeItem.SupplierID == 0)
        {
            await Provider.Execute<Supplier>("sp_Suppliers_Insert", ("CompanyName", activeItem.CompanyName), ("ContactName", activeItem.ContactName), ("Phone", activeItem.Phone));
            DbLogger.Log("Suppliers", "Insert", "New", $"Tedarikçi eklendi: {activeItem.CompanyName}");
        }
        else
        {
            await Provider.Execute<Supplier>("sp_Suppliers_Update", ("SupplierID", activeItem.SupplierID), ("CompanyName", activeItem.CompanyName), ("ContactName", activeItem.ContactName), ("Phone", activeItem.Phone), ("IsActive", activeItem.IsActive));
            DbLogger.Log("Suppliers", "Update", activeItem.SupplierID.ToString(), $"Tedarikçi güncellendi: {activeItem.CompanyName}");
        }
        isModalVisible = false; await LoadData();
    }

    private async Task DeleteItem(Supplier item)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Silmek istediğinize emin misiniz?"))
        {
            await Provider.Execute<Supplier>("sp_Suppliers_Delete", ("SupplierID", item.SupplierID));
            DbLogger.Log("Suppliers", "Delete", item.SupplierID.ToString(), "Tedarikçi silindi.");
            await LoadData();
        }
    }
}