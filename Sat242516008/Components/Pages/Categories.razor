@page "/categories"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]

@using Sat242516008.Models
@using MyDbModels
@using Providers
@using Sat242516008.Loggers
@inject IMyDbModel_Provider Provider
@inject DbLogger DbLogger
@inject IJSRuntime JS
@rendermode InteractiveServer
@attribute [Authorize]

<div class="container-fluid">
    <h3 class="mt-3">Kategori Yönetimi</h3>
    <hr />

    <div class="row mb-3">
        <div class="col-md-5">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Kategori Ara..." @bind="searchTerm" @bind:event="oninput" @onkeypress="HandleEnterKey" />
                <button class="btn btn-primary" @onclick="SearchData">Ara</button>
            </div>
        </div>
        <div class="col-md-7 text-end">
            <button class="btn btn-success" @onclick="OpenCreateModal">+ Yeni Kategori</button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="cursor:pointer" @onclick='() => SortData("CategoryName")'>Kategori Adı ⇅</th>
                        <th>Açıklama</th>
                        <th>Durum</th>
                        <th style="width: 180px;">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (model.Items != null && model.Items.Any())
                    {
                        @foreach (var item in model.Items)
                        {
                            <tr>
                                <td>@item.CategoryName</td>
                                <td>@item.Description</td>
                                <td>@(item.IsActive ? "Aktif" : "Pasif")</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-1" @onclick="() => OpenEditModal(item)">Düzenle</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item)">Sil</button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="4" class="text-center py-3">Kayıt bulunamadı.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @if (model.Parameters.TotalPageCount > 1)
    {
        <div class="d-flex justify-content-center mt-3">
            <nav>
                <ul class="pagination">
                    <li class="page-item @(model.Parameters.PageNumber <= 1 ? "disabled" : "")"><button class="page-link" @onclick="PrevPage">Önceki</button></li>
                    <li class="page-item disabled"><span class="page-link">Sayfa @model.Parameters.PageNumber / @model.Parameters.TotalPageCount</span></li>
                    <li class="page-item @(model.Parameters.PageNumber >= model.Parameters.TotalPageCount ? "disabled" : "")"><button class="page-link" @onclick="NextPage">Sonraki</button></li>
                </ul>
            </nav>
        </div>
    }

    @if (isModalVisible)
    {
        <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">@(activeItem.CategoryID > 0 ? "Kategori Güncelle" : "Yeni Kategori")</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3"><label>Kategori Adı</label><input class="form-control" @bind="activeItem.CategoryName" /></div>
                        <div class="mb-3"><label>Açıklama</label><input class="form-control" @bind="activeItem.Description" /></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" @bind="activeItem.IsActive" id="chkStat"><label class="form-check-label" for="chkStat">Aktif</label></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseModal">İptal</button>
                        <button class="btn btn-primary" @onclick="SaveData">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private MyDbModel<Category> model = new MyDbModel<Category>();
    private Category activeItem = new Category();
    private string searchTerm = "";
    private bool isModalVisible = false;

    protected override async Task OnInitializedAsync() { model.Parameters.OrderBy = "CategoryID DESC"; await LoadData(); }

    private async Task LoadData()
    {
        model.Parameters.Where.Clear();
        if (!string.IsNullOrEmpty(searchTerm)) model.Parameters.Where.Add("Search", searchTerm);
        model = (MyDbModel<Category>)await Provider.Execute<Category>(model, "sp_Categories_List", isPagination: true);
    }

    private async Task SearchData() { model.Parameters.PageNumber = 1; await LoadData(); }
    private async Task HandleEnterKey(KeyboardEventArgs e) { if (e.Key == "Enter") await SearchData(); }
    private async Task SortData(string col) { model.Parameters.OrderBy = col; await LoadData(); }
    private async Task NextPage() { if (model.Parameters.PageNumber < model.Parameters.TotalPageCount) { model.Parameters.PageNumber++; await LoadData(); } }
    private async Task PrevPage() { if (model.Parameters.PageNumber > 1) { model.Parameters.PageNumber--; await LoadData(); } }
    private void OpenCreateModal() { activeItem = new Category { IsActive = true }; isModalVisible = true; }
    private void OpenEditModal(Category item) { activeItem = new Category { CategoryID = item.CategoryID, CategoryName = item.CategoryName, Description = item.Description, IsActive = item.IsActive }; isModalVisible = true; }
    private void CloseModal() => isModalVisible = false;

    private async Task SaveData()
    {
        if (activeItem.CategoryID == 0)
        {
            await Provider.Execute<Category>("sp_Categories_Insert", ("CategoryName", activeItem.CategoryName), ("Description", activeItem.Description));
            DbLogger.Log("Categories", "Insert", "New", $"Kategori eklendi: {activeItem.CategoryName}");
        }
        else
        {
            await Provider.Execute<Category>("sp_Categories_Update", ("CategoryID", activeItem.CategoryID), ("CategoryName", activeItem.CategoryName), ("Description", activeItem.Description), ("IsActive", activeItem.IsActive));
            DbLogger.Log("Categories", "Update", activeItem.CategoryID.ToString(), $"Kategori güncellendi: {activeItem.CategoryName}");
        }
        isModalVisible = false; await LoadData();
    }

    private async Task DeleteItem(Category item)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Silmek istediğinize emin misiniz?"))
        {
            await Provider.Execute<Category>("sp_Categories_Delete", ("CategoryID", item.CategoryID));
            DbLogger.Log("Categories", "Delete", item.CategoryID.ToString(), "Kategori silindi.");
            await LoadData();
        }
    }
}